<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乔儿课表</title>
    <link rel="stylesheet" href="style.css">
</head>
<body onload="init()">
    <div id="content">
        <div class="wx-alert">
            <p class="wx-hint">请点击<span class="wx-menu">···</span>，在🌍默认浏览器中打开 ⬆️</p>
            <p class="wx-error">🔞本页面不支持微信浏览器🔞</p>        
        </div>
        <div class="unlock">
            ❤️<input type="password" id="password" inputmode="numeric" placeholder="爱情密码" size="8">
            <button onclick="unlock()">🔑 解锁</button><br>
            <span class="prompt">输入密码解锁课表</span>
        </div>
    </div>
    <script>
    let iv = new TextEncoder().encode("20240428T142819Z".padEnd(16, ' ').substring(0, 16));
    let encContent = "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";

    async function deriveKeyFromPassword(password, salt, keyLength, iterations) {
        const encoder = new TextEncoder();
        const passwordBuffer = encoder.encode(password);
        const saltBuffer = encoder.encode(salt.padEnd(16, ' ').substring(0, 16));
        const baseKey = await window.crypto.subtle.importKey('raw', passwordBuffer, { name: 'PBKDF2' }, false, ['deriveKey']);
        const key = await window.crypto.subtle.deriveKey(
            {
                name: 'PBKDF2',
                salt: saltBuffer,
                iterations: iterations,
                hash: { name: 'SHA-512' },
            },
            baseKey,
            { name: 'AES-CBC', length: keyLength },
            true,
            ['encrypt', 'decrypt']
        );
        return key;
    }

    async function decryptMessage(chipher, password) {
        let encoded = Uint8Array.from(atob(chipher), c => c.charCodeAt(0));
        // iv will be needed for decryption
        key = await deriveKeyFromPassword(password, "qiaoer2.0", 256, 1314);
        console.log("key:", await window.crypto.subtle.exportKey("jwk", key));
        let decryptedText = await window.crypto.subtle.decrypt(
            { name: "AES-CBC", iv: iv },
            key,
            encoded,
        );
        return new TextDecoder().decode(decryptedText);
    }

    async function unlock() {
        let contentNode = document.getElementById("content");
        let promptNode = document.querySelector(".prompt");
        let passwordNode = document.querySelector("#password");
        let prompt = "请输入密码";
        let password = passwordNode.value;
        if (!password) {
            promptNode.textContent = "密码不能为空";
            return;
        }
        try {
            let html = await decryptMessage(encContent, password);
            console.debug("decrypted:", html);
            if (html)
                contentNode.innerHTML = html;
        }
        catch (e) {
            console.debug("decryption error:", e);
            console.debug(contentNode.innerHTML);
            promptNode.textContent = "密码错误，请重新输入";
            promptNode.classList.add("error");
            return;
        }
    }
    function init() {
        if (navigator.userAgent.toLowerCase().indexOf('micromessenger') > -1) {
            document.querySelector(".wx-alert").style.display = "block";
        }
        else {
            document.querySelector(".unlock").style.display = "block";
            let passwordInput = document.getElementById("password");
            passwordInput.focus();
            passwordInput.addEventListener("keyup", function(event) {
                if (event.keyCode === 13) {
                    console.debug("enter key pressed");
                    event.preventDefault();
                    unlock();
                }
            });
        }
    }
    </script>
</body>
</html>
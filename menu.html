<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>乔儿课表</title>
    <link rel="stylesheet" href="style.css">
</head>
<body onload="init()">
    <div id="content">
        <div class="wx-alert">
            <p class="wx-hint">请点击<span class="wx-menu">···</span>，在🌍默认浏览器中打开 ⬆️</p>
            <p class="wx-error">🔞本页面不支持微信浏览器🔞</p>        
        </div>
        <div class="unlock">
            💝<input type="password" id="password" inputmode="numeric" placeholder="爱情密码" size="8">
            <button onclick="unlock()">🔑 解锁</button><br>
            <span class="prompt">输入密码解锁课表</span>
        </div>
    </div>
    <script>
    let iv = new TextEncoder().encode("20240428T142819Z".padEnd(16, ' ').substring(0, 16));
    let encContent = "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";

    async function deriveKeyFromPassword(password, salt, keyLength, iterations) {
        const encoder = new TextEncoder();
        const passwordBuffer = encoder.encode(password);
        const saltBuffer = encoder.encode(salt.padEnd(16, ' ').substring(0, 16));
        const baseKey = await window.crypto.subtle.importKey('raw', passwordBuffer, { name: 'PBKDF2' }, false, ['deriveKey']);
        const key = await window.crypto.subtle.deriveKey(
            {
                name: 'PBKDF2',
                salt: saltBuffer,
                iterations: iterations,
                hash: { name: 'SHA-512' },
            },
            baseKey,
            { name: 'AES-CBC', length: keyLength },
            true,
            ['encrypt', 'decrypt']
        );
        return key;
    }

    async function decryptMessage(chipher, password) {
        let encoded = Uint8Array.from(atob(chipher), c => c.charCodeAt(0));
        // iv will be needed for decryption
        key = await deriveKeyFromPassword(password, "qiaoer2.0", 256, 1314);
        console.log("key:", await window.crypto.subtle.exportKey("jwk", key));
        let decryptedText = await window.crypto.subtle.decrypt(
            { name: "AES-CBC", iv: iv },
            key,
            encoded,
        );
        return new TextDecoder().decode(decryptedText);
    }

    async function unlock() {
        let contentNode = document.getElementById("content");
        let promptNode = document.querySelector(".prompt");
        let passwordNode = document.querySelector("#password");
        let prompt = "请输入密码";
        let password = passwordNode.value;
        if (!password) {
            promptNode.textContent = "密码不能为空";
            return;
        }
        try {
            let html = await decryptMessage(encContent, password);
            console.debug("decrypted:", html);
            if (html)
                contentNode.innerHTML = html;
        }
        catch (e) {
            console.debug("decryption error:", e);
            console.debug(contentNode.innerHTML);
            promptNode.textContent = "密码错误，请重新输入";
            promptNode.classList.add("error");
            passwordNode.value = "";
            return;
        }
    }
    function init() {
        if (navigator.userAgent.toLowerCase().indexOf('micromessenger') > -1) {
            document.querySelector(".wx-alert").style.display = "block";
        }
        else {
            document.querySelector(".unlock").style.display = "block";
            let passwordInput = document.getElementById("password");
            passwordInput.focus();
            passwordInput.click();
            passwordInput.addEventListener("keyup", function(event) {
                if (event.keyCode === 13) {
                    console.debug("enter key pressed");
                    event.preventDefault();
                    unlock();
                }
            });
        }
    }
    </script>
</body>
</html>